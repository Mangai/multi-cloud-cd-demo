FROM ansibleplaybookbundle/apb-base

LABEL "com.redhat.apb.spec"=\
"X3BhcmFtczogJl9wYXJhbXMKICAtIG5hbWU6IHNlcnZpY2VfbmFtZQogICAgdGl0bGU6IERhdGFi\
YXNlIHNlcnZpY2UgbmFtZQogICAgZGVzY3JpcHRpb246IFRoZSBuYW1lIG9mIHRoZSBzZXJ2aWNl\
LiBVc2VkIHRvIG5hbWUgZHJvcGxldCBhbmQgT3BlblNoaXQgc2VydmljZQogICAgdHlwZTogc3Ry\
aW5nCiAgICBkZWZhdWx0OiBkb215c3FsCiAgICBwYXR0ZXJuOiAiXlthLXpBLVowLTldK1thLXpB\
LVowLTldKlthLXpBLVowLTldKyQiCiAgICByZXF1aXJlZDogdHJ1ZQogIC0gbmFtZTogcmVnaW9u\
CiAgICB0aXRsZTogVGFyZ2V0IHJlZ2lvbgogICAgZGVzY3JpcHRpb246IFJlZ2lvbiB3aGVyZSBW\
TSB3aWxsIGJlIHByb3Zpc2lvbmVkCiAgICB0eXBlOiBlbnVtCiAgICBlbnVtOiBbbnljMSxueWMy\
LG55YzMsc2ZvMSxzZm8yLGFtczIsYW1zMyxzZ3AxLGxvbjEsZnJhMSx0b3IxLGJscjFdCiAgICBk\
ZWZhdWx0OiBzZm8xCiAgICByZWd1aXJlZDogdHJ1ZQogICAgZGlzcGxheV90eXBlOiBzZWxlY3QK\
ICAtIG5hbWU6IG15c3FsX2RhdGFiYXNlCiAgICB0aXRsZTogRGF0YWJhc2UgbmFtZQogICAgZGVz\
Y3JpcHRpb246IFRoZSBuYW1lIG9mIHRoZSBNeVNRTCBkYXRhYmFzZQogICAgdHlwZTogc3RyaW5n\
CiAgICBkZWZhdWx0OiBjYXRhbG9nCiAgICBwYXR0ZXJuOiAiXlthLXpBLVowLTlfXSpbYS16QS1a\
X10rW2EtekEtWjAtOV9dKiQiCiAgICByZXF1aXJlZDogdHJ1ZQogIC0gbmFtZTogbXlzcWxfdXNl\
cgogICAgdGl0bGU6IERhdGFiYXNlIHVzZXJuYW1lCiAgICBkZXNjcmlwdGlvbjogVXNlcm5hbWUg\
dGhhdCB3aWxsIGJlIHVzZWQgdG8gY29ubmVjdCB0byBNeVNRTAogICAgdHlwZTogc3RyaW5nCiAg\
ICBkZWZhdWx0OiBhZG1pbgogICAgcGF0dGVybjogIl5bYS16QS1aMC05X10qW2EtekEtWl9dK1th\
LXpBLVowLTlfXSokIgogICAgcmVxdWlyZWQ6IHRydWUKICAtIG5hbWU6IG15c3FsX3Bhc3N3b3Jk\
CiAgICB0aXRsZTogRGF0YWJhc2UgdXNlciBwYXNzd29yZAogICAgZGVzY3JpcHRpb246IFBhc3N3\
b3JkIHRvIGNvbm5lY3QgdG8gTXlTUUwKICAgIHR5cGU6IHN0cmluZwogICAgcmVxdWlyZWQ6IHRy\
dWUKICAgIGRpc3BsYXlfdHlwZTogcGFzc3dvcmQKdmVyc2lvbjogMS4wCm5hbWU6IG15c3FsLWRp\
Z2l0YWwtb2NlYW4tYXBiCmRlc2NyaXB0aW9uOiBNeVNRTCBkYXRhYmFzZSBmcm9tIERpZ2l0YWwg\
T2NlYW4KYmluZGFibGU6IHRydWUKYXN5bmM6IG9wdGlvbmFsCnRhZ3M6Ci0gZGF0YWJhc2UKLSBt\
eXNxbAptZXRhZGF0YToKICBkaXNwbGF5TmFtZTogIkRpZ2l0YWwgT2NlYW4gTXlTUUwgKEFQQiki\
CiAgbG9uZ0Rlc2NyaXB0aW9uOiAiTXlTUUwgNS43IHJ1bm5pbmcgb24gQ2VudE9zIDcuNCBpbiBE\
aWdpdGFsIE9jZWFuIgogIGNvbnNvbGUub3BlbnNoaWZ0LmlvL2ljb25DbGFzczogaWNvbi1teXNx\
bC1kYXRhYmFzZQogIHByb3ZpZGVyRGlzcGxheU5hbWU6ICJSZWQgSGF0LCBJbmMuIgpwbGFuczoK\
ICAtIG5hbWU6IDUxMm1iCiAgICBkZXNjcmlwdGlvbjogU21hbGwgZHJvcGxldCB3aXRoIE15U1FM\
CiAgICBmcmVlOiB0cnVlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6IERlZmF1bHQg\
KDUxMk1CKQogICAgICBsb25nRGVzY3JpcHRpb246IFRoaXMgcGxhbiBwcm92aWRlcyBzbWFsbCAo\
NTEyTUIpIGRyb3BsZXQgZnJvbSBEaWdpdGFsIE9jZWFuIHdpdGggTXlTUUwKICAgICAgY29zdDog\
JDAuMDAKICAgIHBhcmFtZXRlcnM6ICpfcGFyYW1zCiAgLSBuYW1lOiAyZ2IKICAgIGRlc2NyaXB0\
aW9uOiBTbWFsbCBkcm9wbGV0IHdpdGggTXlTUUwKICAgIGZyZWU6IHRydWUKICAgIG1ldGFkYXRh\
OgogICAgICBkaXNwbGF5TmFtZTogTWVkaXVtICgyR0IpCiAgICAgIGxvbmdEZXNjcmlwdGlvbjog\
VGhpcyBwbGFuIHByb3ZpZGVzIG1lZGl1bSAoMkdCKSBkcm9wbGV0IGZyb20gRGlnaXRhbCBPY2Vh\
biB3aXRoIE15U1FMCiAgICAgIGNvc3Q6ICQxMC4wMCBtb250aGx5CiAgICBwYXJhbWV0ZXJzOiAq\
X3BhcmFtcwogIC0gbmFtZTogNGdiCiAgICBkZXNjcmlwdGlvbjogU21hbGwgZHJvcGxldCB3aXRo\
IE15U1FMCiAgICBmcmVlOiB0cnVlCiAgICBtZXRhZGF0YToKICAgICAgZGlzcGxheU5hbWU6IExh\
cmdlICg0R0IpCiAgICAgIGxvbmdEZXNjcmlwdGlvbjogVGhpcyBwbGFuIHByb3ZpZGVzIGxhcmdl\
ICg0R0IpIGRyb3BsZXQgZnJvbSBEaWdpdGFsIE9jZWFuIHdpdGggTXlTUUwKICAgICAgY29zdDog\
JDQwLjAwIG1vbnRobHkKICAgIHBhcmFtZXRlcnM6ICpfcGFyYW1zCg=="

RUN yum -y install python git python-pip python-wheel && \
    yum update -y all && \
    yum clean all

RUN pip install --upgrade --user apb --cache-dir /tmp pip && \
    pip install --user apb --cache-dir /tmp 'dopy>=0.3.7,<=0.3.7'

RUN chown -R apb:0 /opt/apb && chmod -R g=u /opt/apb /etc/passwd

COPY playbooks /opt/apb/actions
COPY roles /opt/apb/actions/roles
RUN chmod -R g=u /opt/{ansible,apb}
USER apb
ENV ANSIBLE_HOST_KEY_CHECKING false
